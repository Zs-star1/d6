<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إنجازي – لوحة إنجاز المعلم</title>

  <!--
    ✅ ملف واحد (HTML + CSS + JS)
    - RTL + عربي
    - أيقونات SVG مضمّنة (بدون مكاتب خارجية)
    - إدارة حالة محلية عبر localStorage
    - تنقية إدخال المستخدم لمنع XSS
    - نافذة تأكيد/تحرير أنيقة
    - اختبارات وحدة بسيطة (Console) للتحقق من الدوال الحساسة
  -->

  <style>
    :root{
      --bg:#f6f7fb;
      --text:#1f2937;
      --muted:#6b7280;
      --brand:#0f766e;                /* تيفاني/أخضر مزرق */
      --brand-2:#0ea5a3;
      --danger:#dc2626;
      --ok:#16a34a;
      --card:#ffffff;
      --shadow:0 8px 20px rgba(0,0,0,.08);

      /* ألوان بطاقات متنوعة */
      --purple:#7c3aed;
      --purple-200:#ede9fe;
      --olive:#5b7c2e;
      --olive-200:#eef6d6;
      --green:#059669;
      --green-200:#d1fae5;
      --green-dark:#065f46;
      --green-dark-200:#d3f3ea;
      --gray:#cbd5e1;
      --gray-200:#f1f5f9;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      background: var(--bg);
      color:var(--text);
    }

    /* شريط علوي */
    header.topbar{
      background: linear-gradient(180deg, var(--brand) 0%, var(--brand-2) 100%);
      color:#fff;
      padding:18px 20px 28px;
      position:sticky; top:0; z-index:50;
      box-shadow:0 2px 10px rgba(0,0,0,.12);
    }
    .topbar .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width:1200px; margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .avatar{
      width:44px; height:44px; border-radius:12px; overflow:hidden;
      border:2px solid rgba(255,255,255,.6); background:#0b3d3a; display:grid; place-items:center;
    }
    .avatar svg{width:30px; height:30px; fill:#fff}
    .title-wrap h1{
      margin:0; font-size:28px; letter-spacing:.5px;
    }
    .title-wrap small{display:block; opacity:.9}

    .actions{
      display:flex; align-items:center; gap:10px;
    }
    .icon-btn{
      display:inline-grid; place-items:center;
      width:38px; height:38px; border-radius:10px;
      background: rgba(255,255,255,.15);
      border:1px solid rgba(255,255,255,.25);
      backdrop-filter: blur(2px);
      cursor:pointer;
    }
    .icon-btn:hover{background:rgba(255,255,255,.25)}
    .icon-btn svg{width:20px; height:20px; fill:#fff}

    /* شارة تنبيه تجريبي */
    .trial{
      max-width:1200px; margin:14px auto 0; padding:0 20px;
    }
    .alert{
      background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca;
      padding:12px 14px; border-radius:10px; position:relative;
      display:flex; align-items:center; justify-content:center; gap:8px;
      font-weight:600;
    }
    .alert a{color:#b91c1c; text-decoration:underline; cursor:pointer}
    .alert .close{
      position:absolute; inset-inline-end:8px; top:8px; width:28px; height:28px;
      display:grid; place-items:center; border-radius:8px; cursor:pointer; background:#fff0;
      border:1px solid #fca5a5;
    }
    .alert .close:hover{background:#ffe4e6}

    /* قسم التصنيفات */
    .section{
      max-width:1200px; margin:26px auto; padding:0 20px;
    }
    .section .heading{
      display:flex; align-items:center; justify-content:center; gap:10px;
      margin-bottom:16px;
    }
    .chip{
      background:#ecfeff; color:#155e75; border:1px solid #bae6fd;
      padding:10px 16px; border-radius:12px; font-weight:700; box-shadow:var(--shadow);
    }

    /* شبكة البطاقات */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:16px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns: repeat(8, 1fr);} }
    @media (max-width:700px){ .grid{grid-template-columns: repeat(4, 1fr);} }

    .card{
      grid-column: span 4; min-height:140px; background:var(--card); border-radius:16px;
      box-shadow:var(--shadow); position:relative; overflow:hidden; border:1px solid #eef2f7;
      display:flex; flex-direction:column;
    }
    .card .bar{
      display:flex; align-items:center; gap:6px;
      padding:10px; position:absolute; inset-inline-start:10px; top:10px; z-index:2;
    }
    .tiny{
      width:34px; height:34px; border-radius:10px; background:#fff; border:1px solid #e5e7eb;
      display:grid; place-items:center; cursor:pointer;
    }
    .tiny:hover{background:#f3f4f6}
    .tiny svg{width:18px; height:18px; fill:#334155}

    .card .eye{
      position:absolute; inset-inline-end:10px; top:10px;
      width:32px; height:32px; border-radius:10px; background:#fff; border:1px solid #e5e7eb;
      display:grid; place-items:center; opacity:.9;
    }
    .card .eye.hidden{opacity:.35}
    .card .eye svg{width:18px; height:18px; fill:#475569}

    .card .body{
      margin-top:auto; padding:18px; text-align:center; font-weight:700; font-size:18px;
    }

    /* ألوان بطاقات */
    .purple .body{background:var(--purple-200)}
    .purple{border-top:5px solid var(--purple)}
    .olive .body{background:var(--olive-200)}
    .olive{border-top:5px solid var(--olive)}
    .green .body{background:var(--green-200)}
    .green{border-top:5px solid var(--green)}
    .green-dark .body{background:var(--green-dark-200)}
    .green-dark{border-top:5px solid var(--green-dark)}
    .gray .body{background:var(--gray-200)}
    .gray{border-top:5px solid var(--gray)}

    /* تلميح (Tooltip) */
    .tiny[data-tip] { position:relative }
    .tiny[data-tip]::after{
      content: attr(data-tip);
      position:absolute; inset-inline-start:50%; transform:translateX(-50%);
      bottom:calc(100% + 8px);
      background:#111827; color:#fff; font-size:12px; padding:6px 8px; border-radius:8px;
      opacity:0; pointer-events:none; transition:.15s ease; white-space:nowrap;
    }
    .tiny:hover::after{opacity:1}

    /* نافذة منبثقة */
    .modal{
      position:fixed; inset:0; background:rgba(15,23,42,.3);
      display:none; align-items:center; justify-content:center; z-index:80; padding:20px;
    }
    .modal.show{display:flex}
    .sheet{
      width:min(560px, 96vw); background:#fff; border-radius:16px; box-shadow:var(--shadow);
      border:1px solid #e5e7eb; overflow:hidden;
    }
    .sheet header{
      padding:14px 16px; background:#f8fafc; border-bottom:1px solid #e5e7eb; font-weight:800;
    }
    .sheet .content{padding:16px}
    .sheet .row{display:flex; gap:10px; align-items:center}
    .sheet input[type="text"]{
      flex:1; padding:12px 12px; border-radius:10px; border:1px solid #cbd5e1; font-size:15px;
    }
    .sheet .actions{display:flex; gap:8px; justify-content:flex-start; margin-top:12px}
    .btn{
      padding:10px 14px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-weight:700;
    }
    .btn.primary{ background:var(--brand); color:#fff; border-color:transparent }
    .btn.danger{ background:var(--danger); color:#fff; border-color:transparent }
    .btn.ghost{ background:#fff }
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* تذييل */
    footer{
      margin-top:26px; background:#0e7490; color:#ecfeff; text-align:center; padding:16px;
      position:sticky; bottom:0;
    }
    footer a{color:#ecfeff; text-decoration:underline}
  </style>
</head>
<body>

  <!-- الشريط العلوي -->
  <header class="topbar" aria-label="شريط علوي">
    <div class="row">
      <div class="brand">
        <div class="avatar" aria-hidden="true">
          <!-- أيقونة شخصية -->
          <svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5.006 5.006 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14Z"/></svg>
        </div>
        <div class="title-wrap">
          <h1>إنجازي</h1>
          <small>عبدالرحمن سليمان طاهر الحجيلي</small>
        </div>
      </div>

      <div class="actions" role="group" aria-label="إجراءات">
        <button class="icon-btn" title="معلومات">
          <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-6h2Zm0-8h-2V7h2Z"/></svg>
        </button>
        <button class="icon-btn" title="الرسائل">
          <svg viewBox="0 0 24 24"><path d="M21 6H3a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h5l4 3 4-3h5a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1Zm-1.4 2L12 12.75 4.4 8Z"/></svg>
        </button>
        <button class="icon-btn" title="التنبيهات">
          <svg viewBox="0 0 24 24"><path d="M12 22a2.5 2.5 0 0 0 2.45-2h-4.9A2.5 2.5 0 0 0 12 22ZM19 17h-1V11a6 6 0 0 0-5-5.91V4a1 1 0 0 0-2 0v1.09A6 6 0 0 0 6 11v6H5a1 1 0 0 0 0 2h14a1 1 0 0 0 0-2Z"/></svg>
        </button>
        <button class="icon-btn" title="مشاركة عامة">
          <svg viewBox="0 0 24 24"><path d="M18 8a3 3 0 1 0-2.816-4H12a1 1 0 0 0 0 2h2.184A3 3 0 0 0 18 8ZM6 16a3 3 0 1 0 2.816 4H12a1 1 0 0 0 0-2H8.816A3 3 0 0 0 6 16Zm12 0a3 3 0 1 0-2.816-4H12a1 1 0 0 0 0 2h3.184A3 3 0 0 0 18 16Z"/></svg>
        </button>
      </div>
    </div>

    <!-- شارة الحساب التجريبي -->
    <div class="trial">
      <div class="alert" role="alert">
        حسابك تجريبي للاستفادة من المميزات
        <a id="activateLink">انقر هنا للتفعيل</a>
        <button class="close" id="closeAlert" aria-label="إغلاق التنبيه">✕</button>
      </div>
    </div>
  </header>

  <!-- قسم التصنيفات -->
  <section class="section" aria-labelledby="catsTitle">
    <div class="heading">
      <div class="chip" id="catsTitle">التصنيفات</div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>
  </section>

  <!-- تذييل -->
  <footer>
    الحقوق محفوظة إنجاز المعلم · <a href="#" id="support">تطوير</a>
  </footer>

  <!-- نافذة التحرير/الحذف -->
  <div class="modal" id="modal">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
      <header id="dlgTitle">تحرير البطاقة</header>
      <div class="content">
        <div class="row">
          <label for="titleInput" style="font-weight:700; white-space:nowrap;">عنوان البطاقة</label>
          <input id="titleInput" type="text" placeholder="أدخل عنوانًا واضحًا" maxlength="40" />
        </div>
        <div class="actions">
          <button class="btn primary" id="saveBtn">حفظ</button>
          <button class="btn danger" id="deleteBtn">حذف</button>
          <button class="btn ghost" id="cancelBtn">إلغاء</button>
        </div>
        <p style="color:var(--muted); font-size:13px; margin-top:10px;">
          ⚠️ يتم حفظ التغييرات محليًا على متصفحك (localStorage).
        </p>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       أدوات SVG للأيقونات الصغيرة
       ========================= */
    const Icons = {
      pencil: '<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75ZM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75ZM3 21h18"/></svg>',
      share:  '<svg viewBox="0 0 24 24"><path d="M18 8a3 3 0 1 0-2.82-4A3 3 0 0 0 18 8ZM6 16a3 3 0 1 0 2.82 4A3 3 0 0 0 6 16Zm12 0a3 3 0 1 0-2.82-4A3 3 0 0 0 18 16Z"/></svg>',
      trash:  '<svg viewBox="0 0 24 24"><path d="M9 3h6a1 1 0 0 1 1 1v1h4a1 1 0 0 1 0 2h-1v12a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V7H4a1 1 0 0 1 0-2h4V4a1 1 0 0 1 1-1Zm1 4H7v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V7h-3Zm0 3a1 1 0 0 1 2 0v7a1 1 0 0 1-2 0Zm4 0a1 1 0 0 1 2 0v7a1 1 0 0 1-2 0Z"/></svg>',
      eye:    '<svg viewBox="0 0 24 24"><path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7Zm0 12a5 5 0 1 1 5-5 5 5 0 0 1-5 5Z"/></svg>',
      eyeOff:'<svg viewBox="0 0 24 24"><path d="M2 2 22 22M10.58 5.08A9.77 9.77 0 0 1 12 5c7 0 11 7 11 7a17.2 17.2 0 0 1-4.29 4.64M5.49 5.49A17.61 17.61 0 0 0 1 12s4 7 11 7a9.88 9.88 0 0 0 3.61-.66"/></svg>'
    };

    /* =========================
       الحالة + التخزين المحلي
       ========================= */
    const StorageKey = 'engazy.categories.v1';
    const initialCategories = [
      {id:'follow',      title:'سجل المتابعة',   color:'olive',     hidden:false},
      {id:'certs',       title:'الشهادات',       color:'green-dark',hidden:false},
      {id:'courses',     title:'الدورات',        color:'green',     hidden:false},
      {id:'cv',          title:'السيرة الذاتية', color:'purple',    hidden:false},
      {id:'basic',       title:'البيانات الأساسية',color:'purple',  hidden:false},
      {id:'quran',       title:'القرآن الكريم',   color:'purple',    hidden:false},
      {id:'blank',       title:'title',           color:'gray',      hidden:false},
      {id:'criteria',    title:'معايير الشواهد',  color:'green',     hidden:false},
      {id:'worksheets',  title:'أوراق عمل',       color:'purple',    hidden:false},
      {id:'library',     title:'مكتبتي',          color:'purple',    hidden:false},
      {id:'curriculum',  title:'منهجي',           color:'purple',    hidden:false},
    ];

    const State = {
      cats: [],
      currentId: null,
      load(){
        try{
          const raw = localStorage.getItem(StorageKey);
          this.cats = raw ? JSON.parse(raw) : initialCategories;
        }catch(e){
          console.warn('فشل قراءة التخزين المحلي، سيتم استخدام القيم الافتراضية.', e);
          this.cats = initialCategories;
        }
      },
      save(){
        try{ localStorage.setItem(StorageKey, JSON.stringify(this.cats)); }
        catch(e){ console.error('تعذر الحفظ في localStorage', e); }
      },
      byId(id){ return this.cats.find(c => c.id === id); },
      updateTitle(id, title){
        const c = this.byId(id); if(!c) return false;
        c.title = title; this.save(); return true;
      },
      toggleHidden(id){
        const c = this.byId(id); if(!c) return;
        c.hidden = !c.hidden; this.save();
      },
      remove(id){
        this.cats = this.cats.filter(c => c.id !== id);
        this.save();
      }
    };

    /* =========================
       أدوات أمان بسيطة
       ========================= */
    function sanitize(input){
      // نزيل المسافات الزائدة ونمنع إدخال وسوم HTML
      const s = (input ?? '').toString().trim();
      // حذف أي زاويتين قد تستعمل لوسوم
      return s.replace(/[<>]/g,'').slice(0, 40);
    }

    /* =========================
       واجهة المستخدم
       ========================= */
    const dom = {
      grid: document.getElementById('grid'),
      modal: document.getElementById('modal'),
      titleInput: document.getElementById('titleInput'),
      saveBtn: document.getElementById('saveBtn'),
      deleteBtn: document.getElementById('deleteBtn'),
      cancelBtn: document.getElementById('cancelBtn'),
      closeAlert: document.getElementById('closeAlert'),
      activateLink: document.getElementById('activateLink')
    };

    function cardTemplate(cat){
      return `
      <article class="card ${cat.color}" data-id="${cat.id}" aria-label="بطاقة ${cat.title}">
        <div class="bar">
          <button class="tiny js-edit"  data-tip="تحرير" aria-label="تحرير">${Icons.pencil}</button>
          <button class="tiny js-share" data-tip="مشاركة" aria-label="مشاركة">${Icons.share}</button>
          <button class="tiny js-del"   data-tip="حذف" aria-label="حذف">${Icons.trash}</button>
        </div>
        <div class="eye ${cat.hidden ? 'hidden':''} js-eye" role="button" tabindex="0" aria-label="إظهار/إخفاء">
          ${cat.hidden ? Icons.eyeOff : Icons.eye}
        </div>
        <div class="body">${cat.title}</div>
      </article>
      `;
    }

    function render(){
      dom.grid.innerHTML = State.cats.map(cardTemplate).join('');
    }

    /* =========================
       سلوكيات
       ========================= */
    function openModal(id){
      State.currentId = id;
      const c = State.byId(id);
      if(!c) return;
      dom.titleInput.value = c.title;
      dom.modal.classList.add('show');
      dom.titleInput.focus();
    }
    function closeModal(){
      State.currentId = null;
      dom.modal.classList.remove('show');
    }

    // مشاركة: إنشاء رابط وهمي آمن ونسخه
    async function shareCard(id){
      const c = State.byId(id); if(!c) return;
      const safeTitle = encodeURIComponent(c.title);
      const url = `${location.origin}${location.pathname}#card=${encodeURIComponent(id)}&title=${safeTitle}`;
      try{
        await navigator.clipboard.writeText(url);
        toast('تم نسخ رابط المشاركة إلى الحافظة.');
      }catch{
        // نسخ احتياطي
        const text = document.createElement('textarea');
        text.value = url; document.body.appendChild(text);
        text.select(); document.execCommand('copy'); text.remove();
        toast('تم نسخ الرابط.');
      }
    }

    // إشعار بسيط
    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.cssText = `
        position:fixed; inset-inline-start:50%; transform:translateX(-50%);
        bottom:20px; background:#111827; color:#fff; padding:10px 14px;
        border-radius:10px; z-index:90; box-shadow:${getComputedStyle(document.documentElement).getPropertyValue('--shadow')};
        font-weight:700;`;
      document.body.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transition='.25s'; }, 1500);
      setTimeout(()=>el.remove(), 1900);
    }

    // تفويض أحداث الشبكة
    dom.grid.addEventListener('click', (e)=>{
      const card = e.target.closest('.card'); if(!card) return;
      const id = card.dataset.id;
      if(e.target.closest('.js-edit'))  return openModal(id);
      if(e.target.closest('.js-share')) return shareCard(id);
      if(e.target.closest('.js-del'))   return confirmDelete(id);
      if(e.target.closest('.js-eye'))   return toggleEye(card, id);
    });

    function toggleEye(card, id){
      State.toggleHidden(id);
      const eye = card.querySelector('.js-eye');
      const hidden = State.byId(id).hidden;
      eye.classList.toggle('hidden', hidden);
      eye.innerHTML = hidden ? Icons.eyeOff : Icons.eye;
    }

    function confirmDelete(id){
      // استخدام نفس نافذة التحرير لزر حذف (أحمر)
      openModal(id);
      dom.deleteBtn.focus();
    }

    // أزرار النافذة
    dom.saveBtn.addEventListener('click', ()=>{
      const id = State.currentId; if(!id) return;
      const val = sanitize(dom.titleInput.value);
      if(!val){ alert('الرجاء إدخال عنوان صحيح.'); return; }
      State.updateTitle(id, val);
      render(); closeModal(); toast('تم الحفظ.');
    });
    dom.deleteBtn.addEventListener('click', ()=>{
      const id = State.currentId; if(!id) return;
      // نافذة تأكيد مخصصة
      if(confirm('سيتم حذف البطاقة نهائيًا. هل أنت متأكد؟')){
        State.remove(id); render(); closeModal(); toast('تم الحذف.');
      }
    });
    dom.cancelBtn.addEventListener('click', closeModal);
    dom.modal.addEventListener('click', (e)=>{ if(e.target === dom.modal) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); }, {passive:true});

    // شارة تفعيل الحساب (عرض تجريبي)
    dom.closeAlert.addEventListener('click', ()=> document.querySelector('.trial').remove());
    dom.activateLink.addEventListener('click', ()=>{
      toast('تم تحويلك افتراضيًا لصفحة التفعيل (تجريبي).');
    });

    // تحميل أولي
    State.load(); render();

    /* =========================
       اختبارات وحدة بسيطة (Console)
       ========================= */
    (function tests(){
      const assert = (name, cond) => console[cond?'log':'error'](`%c[${cond?'PASS':'FAIL'}] ${name}`, `color:${cond?'#16a34a':'#dc2626'}; font-weight:700`);
      // sanitize
      assert('sanitize يحذف الوسوم', sanitize('<img src=x onerror=alert(1)>شهادة') === 'img src=x onerror=alert(1)شهادة');
      assert('sanitize يحد الطول', sanitize('a'.repeat(200)).length === 40);
      // state
      const before = JSON.stringify(State.cats);
      State.updateTitle(State.cats[0].id, 'عنوان');
      assert('updateTitle يحدّث العنوان', State.cats[0].title === 'عنوان');
      State.toggleHidden(State.cats[0].id);
      assert('toggleHidden يبدّل الإخفاء', typeof State.cats[0].hidden === 'boolean');
      // استرجاع الحالة السابقة
      State.cats = JSON.parse(before); State.save(); render();
    })();
  </script>
</body>
</html>
